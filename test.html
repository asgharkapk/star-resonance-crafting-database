<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Economy Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg: #111;
            --panel: rgba(20, 20, 20, 0.95);
            --border: #444;
            --accent: #00d2ff;
            --text: #eee;
            --money: #ffd700; /* Gold/LB */
            --labor: #ff6b6b; /* F/Labor */
            --token: #adff2f; /* H/Tokens */
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; display: flex; height: 100vh; }

        /* --- LEFT CONTROLS --- */
        #controls {
            width: 250px; padding: 15px; background: var(--panel);
            border-right: 1px solid var(--border); z-index: 10;
            display: flex; flex-direction: column; gap: 15px;
        }
        
        h2 { margin: 0 0 10px 0; font-size: 18px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        
        .btn-group { display: flex; flex-direction: column; gap: 5px; }
        
        input[type="file"] { font-size: 12px; color: #aaa; }
        
        .stat-box { font-size: 12px; color: #888; }

        /* --- GRAPH AREA --- */
        #viz { flex: 1; position: relative; cursor: grab; }
        #viz:active { cursor: grabbing; }

        /* Node Styling (First Design) */
        .node-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            border-radius: 8px; padding: 5px; box-sizing: border-box;
            border: 2px solid #fff; box-shadow: 0 0 10px rgba(0,210,255, 0.2);
            background: rgba(40,40,40,0.9); transition: transform 0.2s;
        }
        .node-container:hover { transform: scale(1.1); z-index: 100; border-color: var(--accent); }
        
        .node-name { font-weight: bold; font-size: 12px; word-wrap: break-word; }
        .node-detail { font-size: 10px; color: #ccc; margin-top: 2px; }

        /* Node Colors */
        .type-source { border-color: #777; background: #222; }
        .type-product { border-color: var(--accent); background: #1e2d35; }

        /* Lines */
        .link { fill: none; stroke: #555; stroke-width: 1.5px; }
        .link-label-bg { fill: #111; opacity: 0.8; }
        .link-text { font-size: 9px; fill: #ccc; text-anchor: middle; }

        /* --- RIGHT SIDEBAR (ADVANCED CALCULATOR) --- */
        #calculator {
            width: 400px; background: var(--panel);
            border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
            z-index: 20;
            transition: transform 0.3s;
            transform: translateX(100%); /* Hidden by default */
            position: absolute; right: 0; top: 0; bottom: 0;
        }
        #calculator.open { transform: translateX(0); }

        .calc-header { padding: 15px; background: #222; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .close-btn { cursor: pointer; font-weight: bold; color: #ff6b6b; }

        .calc-body { flex: 1; overflow-y: auto; padding: 15px; }

        /* Calculation Tree CSS */
        .calc-row { margin-bottom: 15px; border-left: 2px solid #444; padding-left: 10px; position: relative; }
        .calc-row.depth-0 { border: none; padding: 0; }
        
        .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .item-title { font-weight: bold; color: var(--accent); font-size: 14px; }
        
        .strategy-select { background: #333; color: white; border: 1px solid #555; padding: 2px; font-size: 11px; border-radius: 3px; }
        
        .inputs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; color: #aaa; margin-bottom: 5px; }
        .input-group input { width: 100%; background: #111; border: 1px solid #444; color: white; text-align: right; padding: 3px; }

        .sub-ingredients { margin-left: 10px; display: none; } /* Hidden if Buying */
        .sub-ingredients.show { display: block; }

        .cost-display { font-size: 11px; text-align: right; color: #fff; padding-top: 2px; border-top: 1px dashed #333; }
        .currency-lb { color: var(--money); }
        .currency-f { color: var(--labor); }
        .currency-h { color: var(--token); }

        /* Sticky Summary Footer */
        .calc-footer { padding: 15px; background: #000; border-top: 1px solid var(--border); font-size: 13px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .profit-val { font-size: 18px; font-weight: bold; }
        .profit-pos { color: #4cd137; } 
        .profit-neg { color: #ff6b6b; }

    </style>
</head>
<body>

<!-- LEFT SIDEBAR -->
<div id="controls">
    <h2>Data Source</h2>
    <div class="stat-box">
        Select folder containing CSVs.<br>
        (Includes subfolders automatically)
    </div>
    <input type="file" id="dirInput" webkitdirectory multiple />
    <div id="loadStatus" class="stat-box" style="color: var(--accent)"></div>
    
    <div style="margin-top: 20px; font-size: 11px; color: #666;">
        <b>How to use:</b><br>
        1. Load Data.<br>
        2. Click a Final Item node.<br>
        3. Use the Calculator sidebar.<br>
        4. Toggle "Craft" vs "Buy" for components.
    </div>
</div>

<!-- MAIN GRAPH -->
<div id="viz"></div>

<!-- RIGHT CALCULATOR -->
<div id="calculator">
    <div class="calc-header">
        <span id="calc-item-name">Item Calculator</span>
        <span class="close-btn" onclick="toggleCalc(false)">✕</span>
    </div>
    <div class="calc-body" id="calc-content">
        <!-- Recursive Tree generated here -->
    </div>
    <div class="calc-footer">
        <div class="summary-row">
            <span>Total Sell Value:</span>
            <span id="sum-revenue" class="currency-lb">0 LB</span>
        </div>
        <div class="summary-row">
            <span>Total Expenses:</span>
            <span id="sum-expense-lb" class="currency-lb">0 LB</span>
        </div>
        <div class="summary-row">
            <span>Other Costs:</span>
            <span>
                <span id="sum-expense-f" class="currency-f">0 F</span> | 
                <span id="sum-expense-h" class="currency-h">0 H</span>
            </span>
        </div>
        <div style="border-top: 1px solid #333; margin: 5px 0;"></div>
        <div class="summary-row" style="align-items: center;">
            <span>NET PROFIT:</span>
            <span id="sum-profit" class="profit-val">0</span>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. DATA ENGINE
    // ==========================================
    const DB = {
        nodes: {},   // Map: "Ruby" -> { id, type }
        recipes: [], // Array: { source, target, qtyIn, qtyOut, cost, currency, action }
        
        // Lookup Map for Calculator: "Ruby" -> [Recipe1, Recipe2]
        recipesByTarget: {} 
    };

    // To prevent duplicates
    const recipeHash = new Set();

    // --- CSV Parser ---
    function parseCurrency(str) {
        // Examples: "200LB", "20F", "220H", "0F"
        if (!str) return { val: 0, type: '' };
        const val = parseFloat(str.replace(/[^0-9.]/g, ''));
        let type = str.replace(/[0-9.\s]/g, '').toUpperCase();
        // Normalize currency names
        if(type === '') type = 'LB'; 
        return { val: isNaN(val) ? 0 : val, type: type };
    }

    function processCSV(text) {
        const lines = text.split(/\r?\n/);
        lines.forEach(line => {
            if (!line.trim() || line.startsWith('action')) return;
            
            const cols = line.split(',').map(c => c.trim());
            if (cols.length < 6) return;

            // Columns: action, qtyIn, source, qtyOut, target, costRaw
            const action = cols[0];
            const qtyIn = parseFloat(cols[1]) || 1;
            const source = cols[2].replace(/.*:/, '').trim(); // Remove "Artisanry:"
            const qtyOut = parseFloat(cols[3]) || 1;
            const target = cols[4];
            const costObj = parseCurrency(cols[5]);

            // Generate Hash to skip duplicates
            const hash = `${source}-${target}-${action}-${cols[5]}`;
            if(recipeHash.has(hash)) return;
            recipeHash.add(hash);

            // Store Nodes
            if(!DB.nodes[source]) DB.nodes[source] = { id: source, type: 'source' };
            if(!DB.nodes[target]) DB.nodes[target] = { id: target, type: 'product' };
            
            // Mark as product if it's a target, even if it was a source elsewhere
            DB.nodes[target].type = 'product'; 

            // Store Recipe
            const recipe = {
                source: source,
                target: target,
                qtyIn: qtyIn,
                qtyOut: qtyOut,
                cost: costObj.val,
                currency: costObj.type,
                action: action // CRAFTING, STORE, GATHERING
            };
            DB.recipes.push(recipe);

            // Index for Calculator
            if(!DB.recipesByTarget[target]) DB.recipesByTarget[target] = [];
            DB.recipesByTarget[target].push(recipe);
        });
    }

    document.getElementById('dirInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files); // subdirectories included automatically by input
        recipeHash.clear();
        DB.nodes = {};
        DB.recipes = [];
        DB.recipesByTarget = {};

        let count = 0;
        const promises = files.map(file => {
            if(!file.name.endsWith('.csv')) return Promise.resolve();
            return file.text().then(text => {
                processCSV(text);
                count++;
            });
        });

        await Promise.all(promises);
        document.getElementById('loadStatus').innerText = `Loaded ${count} files. Found ${DB.recipes.length} recipes.`;
        
        initGraph();
    });

    // ==========================================
    // 2. VISUALIZATION (D3)
    // ==========================================
    const viz = document.getElementById('viz');
    let simulation, svg, g;

    function initGraph() {
        viz.innerHTML = '';
        const width = viz.clientWidth;
        const height = viz.clientHeight;

        svg = d3.select("#viz").append("svg")
            .attr("width", width).attr("height", height)
            .call(d3.zoom().on("zoom", (e) => g.attr("transform", e.transform)))
            .on("dblclick.zoom", null);

        // Arrow Marker
        svg.append("defs").append("marker")
            .attr("id", "arrow")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 55).attr("refY", 0)
            .attr("markerWidth", 6).attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", "#555");

        g = svg.append("g");

        const nodesArray = Object.values(DB.nodes);
        const linksArray = DB.recipes.map(r => ({ ...r })); // Clone

        simulation = d3.forceSimulation(nodesArray)
            .force("link", d3.forceLink(linksArray).id(d => d.id).distance(200))
            .force("charge", d3.forceManyBody().strength(-1000))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide(60));

        // Draw Links
        const link = g.selectAll(".link-group")
            .data(linksArray)
            .join("g");

        const linkPath = link.append("path")
            .attr("class", "link")
            .attr("marker-end", "url(#arrow)");

        const linkLabel = link.append("g");
        linkLabel.append("rect").attr("class", "link-label-bg").attr("rx",3);
        linkLabel.append("text").attr("class", "link-text")
            .attr("dy", 3)
            .text(d => `${d.qtyIn} → ${d.qtyOut} (${d.cost}${d.currency})`);
        
        // Size backgrounds
        linkLabel.each(function() {
            const box = this.querySelector('text').getBBox();
            d3.select(this).select('rect')
                .attr("x", box.x - 2).attr("y", box.y - 2)
                .attr("width", box.width + 4).attr("height", box.height + 4);
        });

        // Draw Nodes
        const node = g.selectAll(".node")
            .data(nodesArray)
            .join("foreignObject")
            .attr("width", 100).attr("height", 60)
            .call(d3.drag().on("start", dragStart).on("drag", dragged).on("end", dragEnd))
            .on("click", (e, d) => openCalculator(d.id));

        node.append("xhtml:div")
            .attr("class", d => `node-container type-${d.type}`)
            .html(d => `<div class="node-name">${d.id}</div>`);

        simulation.on("tick", () => {
            node.attr("x", d => d.x - 50).attr("y", d => d.y - 30);
            
            linkPath.attr("d", d => `M${d.source.x},${d.source.y} L${d.target.x},${d.target.y}`);
            
            linkLabel.attr("transform", d => {
                const x = (d.source.x + d.target.x) / 2;
                const y = (d.source.y + d.target.y) / 2;
                return `translate(${x},${y})`;
            });
        });
    }

    function dragStart(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
    }
    function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
    function dragEnd(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
    }

    // ==========================================
    // 3. ADVANCED CALCULATOR
    // ==========================================
    
    // State object for the calculator
    // { "Ruby": { method: "craft", buyPrice: 0, sellPrice: 8000 }, "Resin": { method: "farm", ... } }
    let calcState = {}; 
    let currentTarget = null;

    function toggleCalc(show) {
        const el = document.getElementById('calculator');
        if(show) el.classList.add('open');
        else el.classList.remove('open');
    }

    function openCalculator(itemId) {
        currentTarget = itemId;
        calcState = {}; // Reset state
        document.getElementById('calc-item-name').innerText = itemId;
        const container = document.getElementById('calc-content');
        container.innerHTML = '';

        // Build Recursive UI
        // We start with quantity 1 of the target item
        buildCalcRow(container, itemId, 1, 0);
        
        toggleCalc(true);
        recalculateAll();
    }

    // Recursive UI Builder
    function buildCalcRow(container, itemId, qtyNeeded, depth) {
        // Initialize State if new
        if(!calcState[itemId]) {
            const recipes = DB.recipesByTarget[itemId];
            calcState[itemId] = {
                method: (recipes && recipes.length > 0) ? 'craft' : 'buy', // Default to craft if possible
                buyPrice: 0,
                sellPrice: 0,
                recipeIndex: 0 // Which recipe to use if multiple
            };
        }

        const rowId = `row-${Math.random().toString(36).substr(2,9)}`;
        const recipes = DB.recipesByTarget[itemId] || [];
        const hasRecipe = recipes.length > 0;

        const div = document.createElement('div');
        div.className = `calc-row depth-${depth}`;
        div.dataset.id = itemId;
        div.dataset.qty = qtyNeeded;
        
        // --- Header ---
        let html = `
            <div class="row-header">
                <span class="item-title">${qtyNeeded}x ${itemId}</span>
                <select class="strategy-select" onchange="updateMethod('${itemId}', this, '${rowId}')">
                    <option value="buy" ${calcState[itemId].method === 'buy' ? 'selected' : ''}>Buy (Market)</option>
                    ${hasRecipe ? `<option value="craft" ${calcState[itemId].method === 'craft' ? 'selected' : ''}>Craft / Process</option>` : ''}
                    <option value="farm" ${calcState[itemId].method === 'farm' ? 'selected' : ''}>Farm / Gather (Free)</option>
                </select>
            </div>
        `;

        // --- Inputs (Prices) ---
        // Only show Sell Price for the root item (depth 0)
        // Show Buy Price for everyone (used if method is Buy)
        html += `
            <div class="inputs-grid">
                <div class="input-group">
                    Buy Price: <input type="number" value="${calcState[itemId].buyPrice}" 
                    oninput="updatePrice('${itemId}', 'buyPrice', this.value)" placeholder="Unit Price">
                </div>
                ${depth === 0 ? `
                <div class="input-group">
                    Sell Price: <input type="number" value="${calcState[itemId].sellPrice}" 
                    oninput="updatePrice('${itemId}', 'sellPrice', this.value)" placeholder="Unit Price">
                </div>` : ''}
            </div>
        `;
        
        // --- Recipe Selector (if multiple) ---
        if(hasRecipe && recipes.length > 1) {
            html += `<div style="margin-bottom:5px; font-size:10px;">
                Recipe: <select onchange="updateRecipe('${itemId}', this.selectedIndex, '${rowId}')">
                    ${recipes.map((r, i) => `<option value="${i}" ${calcState[itemId].recipeIndex === i ? 'selected' : ''}>via ${r.source} (${r.action})</option>`).join('')}
                </select>
            </div>`;
        }

        // --- Sub Ingredients Container ---
        html += `<div class="sub-ingredients ${calcState[itemId].method === 'craft' ? 'show' : ''}" id="${rowId}-subs"></div>`;
        
        // --- Cost Display ---
        html += `<div class="cost-display" id="${rowId}-cost">...</div>`;

        div.innerHTML = html;
        container.appendChild(div);

        // Recursively add children if Crafting
        if(hasRecipe) {
            const subsContainer = div.querySelector('.sub-ingredients');
            const activeRecipe = recipes[calcState[itemId].recipeIndex];
            
            // Calculate how many crafts needed
            // If recipe makes 15, and we need 30, we craft 2 times.
            // If recipe makes 15, and we need 1, we still craft 1 time (usually).
            // Let's assume fractional crafting is allowed for math, or user rounds up.
            // For exact logic: Math.ceil(qtyNeeded / activeRecipe.qtyOut). 
            // Let's use exact proportion for profit calc.
            
            const ratio = qtyNeeded / activeRecipe.qtyOut; 
            const subQty = activeRecipe.qtyIn * ratio;
            
            // Render Source Item
            buildCalcRow(subsContainer, activeRecipe.source, parseFloat(subQty.toFixed(2)), depth + 1);
        }
    }

    // --- Calculator Logic Handlers ---

    window.updateMethod = function(itemId, select, rowId) {
        calcState[itemId].method = select.value;
        // Toggle visibility of sub-ingredients
        const subs = document.getElementById(`${rowId}-subs`);
        if(subs) {
            subs.style.display = select.value === 'craft' ? 'block' : 'none';
        }
        recalculateAll();
    };

    window.updatePrice = function(itemId, type, val) {
        calcState[itemId][type] = parseFloat(val) || 0;
        recalculateAll();
    };
    
    window.updateRecipe = function(itemId, index, rowId) {
        calcState[itemId].recipeIndex = parseInt(index);
        // Full re-render of this branch needed to change ingredients
        // For simplicity, we just re-open the whole calculator for now or refresh
        openCalculator(currentTarget); 
    };

    function recalculateAll() {
        // Start from top
        const rootContainer = document.getElementById('calc-content').firstElementChild;
        if(!rootContainer) return;

        const results = getCostRecursive(rootContainer);
        
        // Update Footer
        const rootState = calcState[currentTarget];
        const totalRevenue = rootState.sellPrice * 1; // Qty is 1 for top level

        document.getElementById('sum-revenue').innerText = totalRevenue.toLocaleString() + " LB";
        document.getElementById('sum-expense-lb').innerText = results.costLB.toLocaleString() + " LB";
        document.getElementById('sum-expense-f').innerText = results.costF.toLocaleString() + " F";
        document.getElementById('sum-expense-h').innerText = results.costH.toLocaleString() + " H";

        const profit = totalRevenue - results.costLB;
        const pEl = document.getElementById('sum-profit');
        pEl.innerText = profit.toLocaleString() + " LB";
        pEl.className = profit >= 0 ? "profit-val profit-pos" : "profit-val profit-neg";
    }

    function getCostRecursive(rowEl) {
        const itemId = rowEl.dataset.id;
        const qty = parseFloat(rowEl.dataset.qty);
        const state = calcState[itemId];
        
        let costLB = 0, costF = 0, costH = 0;

        if (state.method === 'buy') {
            // Buy from Market
            costLB = state.buyPrice * qty;
        } 
        else if (state.method === 'farm') {
            // Farm (Free money)
            // Check if there is a recipe associated with the gathering?
            // The CSV might say "Action: GATHERING, Cost: 20F".
            const recipes = DB.recipesByTarget[itemId];
            if(recipes && recipes.length > 0) {
                const r = recipes[state.recipeIndex];
                // Process costs if they exist in the gathering recipe
                const ratio = qty / r.qtyOut;
                if(r.currency === 'F') costF += r.cost * ratio;
                if(r.currency === 'H') costH += r.cost * ratio;
                if(r.currency === 'LB') costLB += r.cost * ratio;
            }
        }
        else if (state.method === 'craft') {
            // Recurse children
            const subContainer = rowEl.querySelector('.sub-ingredients');
            Array.from(subContainer.children).forEach(childRow => {
                const res = getCostRecursive(childRow);
                costLB += res.costLB;
                costF += res.costF;
                costH += res.costH;
            });

            // Add Crafting Fee of THIS step
            const recipes = DB.recipesByTarget[itemId];
            if(recipes) {
                const r = recipes[state.recipeIndex];
                const ratio = qty / r.qtyOut;
                if(r.currency === 'F') costF += r.cost * ratio;
                if(r.currency === 'H') costH += r.cost * ratio;
                if(r.currency === 'LB') costLB += r.cost * ratio;
            }
        }

        // Update Row Display
        const displayEl = rowEl.querySelector('.cost-display');
        if(displayEl) {
            let txt = [];
            if(costLB > 0) txt.push(`<span class="currency-lb">${costLB.toFixed(0)} LB</span>`);
            if(costF > 0) txt.push(`<span class="currency-f">${costF.toFixed(0)} F</span>`);
            if(costH > 0) txt.push(`<span class="currency-h">${costH.toFixed(0)} H</span>`);
            if(txt.length === 0) txt.push("Free");
            displayEl.innerHTML = txt.join(' + ');
        }

        return { costLB, costF, costH };
    }

</script>
</body>
</html>
