<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Star Resonance: Dynamic DB</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
    /* Dark Theme Styles */
    :root { --bg-dark: #0a0c16; --accent: #00c8ff; --text: #f0f3ff; --panel: rgba(255,255,255,0.05); }
    body { background: radial-gradient(circle at top, #111428, #05060e); color: var(--text); font-family: sans-serif; margin: 0; padding-bottom: 50px; }
    
    /* Layout */
    header, nav { background: rgba(0,0,0,0.5); padding: 10px; text-align: center; border-bottom: 1px solid #333; }
    nav a { margin: 0 10px; color: #888; text-decoration: none; font-weight: bold; }
    nav a:hover { color: var(--accent); }
    main { max-width: 1200px; margin: 20px auto; padding: 0 10px; }
    section { background: var(--panel); border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; }
    
    /* D3 Graph */
    #viz-wrapper { width: 100%; height: 500px; background: #000; border-radius: 8px; overflow: hidden; position: relative; }
    .node-container { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; height: 100%; color: white; border-radius: 6px; border: 1px solid #555; font-size: 11px; padding: 2px; box-sizing: border-box;}
    .type-shop { background: #333; border-color: #f1c40f; }
    .type-item { background: #2c3e50; border-color: #3498db; }
    .type-final { background: #8e44ad; border-color: #e056fd; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border-bottom: 1px solid #333; text-align: left; }
    th { color: var(--accent); }
    .item-link { color: var(--accent); cursor: pointer; text-decoration: underline; }
    
    /* Inputs */
    input, select, button { background: #111; border: 1px solid #555; color: white; padding: 5px; border-radius: 4px; }
    button { cursor: pointer; background: #222; }
    button:hover { background: var(--accent); color: black; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 999; }
    .modal.active { display: flex; }
    .modal-content { background: #151725; padding: 20px; max-width: 500px; border: 1px solid var(--accent); border-radius: 8px; }
</style>
</head>
<body>

<header><h1>Star Resonance: Connected DB</h1></header>
<nav>
    <a href="#viz-section">Visualizer</a>
    <a href="#calc-section">Calculator</a>
    <a href="#data-section">Raw Data</a>
</nav>

<main>
    <!-- 1. GRAPH SECTION -->
    <section id="viz-section">
        <h2>Economy Visualizer</h2>
        <div id="viz-wrapper"><div id="viz-container" style="width:100%;height:100%"></div></div>
    </section>

    <!-- 2. CALCULATOR SECTION -->
    <section id="calc-section">
        <h2>Crafting Calculator</h2>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <select id="calc-item"><option>Loading...</option></select>
            <input type="number" id="calc-amount" value="1" style="width:60px">
            <button onclick="calculateAll()">Calculate</button>
        </div>
        <div id="calc-results"></div>
    </section>

    <!-- 3. DATA SECTION (Your code Output) -->
    <section id="data-section">
        <h2>Database Content</h2>
        <div id="csv-output">Initializing...</div>
    </section>
</main>

<!-- MODAL -->
<div id="item-modal" class="modal">
    <div class="modal-content">
        <span onclick="document.getElementById('item-modal').classList.remove('active')" style="float:right;cursor:pointer;font-size:1.5em">&times;</span>
        <h2 id="modal-title"></h2>
        <div id="modal-details"></div>
    </div>
</div>

<script>
    // ===============================================
    // 1. DATA FETCHING & PARSING (Your provided logic)
    // ===============================================
    let globalRecipes = []; // Stores combined data for Calc/Graph

    async function loadCSV(path){
        const res = await fetch(path);
        const text = await res.text();
        const lines = text.trim().split("\n");
        const headers = lines[0].split(",").map(h=>h.trim());
        return lines.slice(1).map(line => {
            // Simple CSV parsing (handles simple commas)
            const values = line.split(","); 
            const row = {};
            headers.forEach((h,i) => row[h] = values[i]?.trim() || "");
            return row;
        });
    }

    function createTableSection(filename, headers, rows){
        const container = document.getElementById("csv-output");
        const section = document.createElement("div");
        section.innerHTML = `<h3>${filename}</h3><table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>${rows.map(r=>`<tr>${headers.map(h=>`<td>${r[h]}</td>`).join("")}</tr>`).join("")}</tbody></table>`;
        container.appendChild(section);
    }

    async function loadAllCSVs(){
        const DATA_DIR = "../data";
        document.getElementById("csv-output").innerHTML = "";
        
        try {
            const resp = await fetch(`${DATA_DIR}/index.json`);
            if(!resp.ok) throw new Error("Could not find data/index.json");
            const {files} = await resp.json();
            
            for(const file of files){
                const rows = await loadCSV(`${DATA_DIR}/${file}`);
                createTableSection(file, Object.keys(rows[0]), rows);
                
                // Add to global memory
                rows.forEach(r => globalRecipes.push(r));
            }
            console.log("Data loaded from CSVs");
            refreshApp(); // Update Graph and Calc

        } catch(e) {
            console.warn("External data load failed:", e);
            document.getElementById("csv-output").innerHTML = `<p style="color:orange">⚠️ Server/Data not found. Using Demo Data.</p>`;
            useDemoData();
        }
    }

    // Fallback if no files exist
    function useDemoData(){
        globalRecipes = [
            {action:"STORE", to:"Iron Ore", cost:"5", currency:"Gold"},
            {action:"STORE", to:"Oak Wood", cost:"2", currency:"Gold"},
            {action:"CRAFT", from:"Iron Ore", cin:"3", to:"Steel Bar", cout:"3", cost:"10"},
            {action:"CRAFT", from:"Oak Wood", cin:"5", to:"Reinforced Hilt", cout:"1", cost:"15"},
            {action:"CRAFT", from:"Steel Bar+Reinforced Hilt", cin:"2+1", to:"Blade of Eternity", cout:"1", cost:"500"}
        ];
        refreshApp();
    }

    // ===============================================
    // 2. DATA PROCESSING (Bridge to Graph/Calc)
    // ===============================================
    function refreshApp() {
        processDataForGraph();
        updateCalcDropdown();
        calculateAll();
    }

    function processDataForGraph() {
        const nodes = [];
        const links = [];
        const nodeSet = new Set();

        globalRecipes.forEach(r => {
            // Target Node
            if(r.to && !nodeSet.has(r.to)) {
                nodes.push({ id: r.to, name: r.to, type: "item" });
                nodeSet.add(r.to);
            }

            if(r.action === 'STORE') {
                // Shop Node
                let shopName = r.from || "Market";
                let shopId = "SHOP_" + shopName.replace(/\s/g, '');
                if(!nodeSet.has(shopId)) {
                    nodes.push({ id: shopId, name: shopName, type: "shop", currency: r.currency });
                    nodeSet.add(shopId);
                }
                // Link
                links.push({ source: shopId, target: r.to, label: `${r.cost} ${r.currency}`, type: 'buy' });
            
            } else if(r.action === 'CRAFT' || r.category === 'Recipe') {
                // Ingredients
                if(r.from) {
                    r.from.split("+").forEach(ing => {
                        ing = ing.trim();
                        if(!nodeSet.has(ing)) {
                            nodes.push({ id: ing, name: ing, type: "item" }); // weak assumption if ingredient definition missing
                            nodeSet.add(ing);
                        }
                        links.push({ source: ing, target: r.to, label: "Craft", type: 'craft' });
                    });
                }
            }
        });

        drawGraph(nodes, links);
    }

    // ===============================================
    // 3. D3 VISUALIZER
    // ===============================================
    function drawGraph(nodes, links) {
        document.getElementById("viz-container").innerHTML = ""; // Clear old
        const width = document.getElementById("viz-wrapper").clientWidth;
        const height = 500;

        const svg = d3.select("#viz-container").append("svg").attr("width", "100%").attr("height", "100%")
            .call(d3.zoom().on("zoom", (e) => g.attr("transform", e.transform))).append("g");
        
        const g = svg.append("g");

        // Force Simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide(60));

        // Arrows
        svg.append("defs").append("marker")
            .attr("id", "arrow").attr("viewBox", "0 -5 10 10").attr("refX", 50).attr("refY", 0)
            .attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto")
            .append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", "#555");

        const link = g.append("g").selectAll("path").data(links).join("path")
            .attr("stroke", "#555").attr("fill", "none").attr("marker-end", "url(#arrow)");

        const node = g.append("g").selectAll("foreignObject").data(nodes).join("foreignObject")
            .attr("width", 100).attr("height", 60)
            .call(d3.drag()
                .on("start", (e,d)=>{ if(!e.active)simulation.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; })
                .on("drag", (e,d)=>{ d.fx=e.x; d.fy=e.y; })
                .on("end", (e,d)=>{ if(!e.active)simulation.alphaTarget(0); d.fx=null; d.fy=null; }));

        node.append("xhtml:div").attr("class", d => `node-container type-${d.type}`)
            .html(d => `<strong>${d.name}</strong><br><span style="font-size:9px">${d.currency || ''}</span>`);

        simulation.on("tick", () => {
            link.attr("d", d => `M${d.source.x},${d.source.y} L${d.target.x},${d.target.y}`);
            node.attr("x", d => d.x - 50).attr("y", d => d.y - 30);
        });
    }

    // ===============================================
    // 4. CALCULATOR LOGIC
    // ===============================================
    function updateCalcDropdown() {
        const sel = document.getElementById("calc-item");
        sel.innerHTML = "";
        const items = new Set();
        globalRecipes.forEach(r => { if(r.to) items.add(r.to); });
        [...items].sort().forEach(i => {
            const opt = document.createElement("option");
            opt.innerText = i;
            sel.appendChild(opt);
        });
    }

    function resolve(item, amount, inv={}) {
        let needs = {};
        let steps = [];
        
        // Find recipes for this item
        let recipes = globalRecipes.filter(r => r.to === item);
        if(recipes.length === 0) {
            needs[item] = amount;
            return {needs, steps: [`Obtain ${amount}x ${item} (No recipe)`]};
        }

        // Pick first recipe (simple logic)
        let r = recipes[0];
        let outQty = parseFloat(r.cout) || 1;
        let batches = Math.ceil(amount / outQty);

        if(r.action === 'STORE') {
            let cost = (parseFloat(r.cost) || 0) * batches;
            needs[`${r.currency}`] = (needs[`${r.currency}`]||0) + cost;
            steps.push(`Buy ${amount}x ${item} from ${r.from} (${cost} ${r.currency})`);
        } else {
            // Crafting
            let ingNames = r.from.split("+");
            let ingQtys = (r.cin || "").split("+");
            
            steps.push(`Craft ${amount}x ${item}`);
            
            ingNames.forEach((ingName, idx) => {
                let perBatch = parseFloat(ingQtys[idx]) || 1;
                let totalReq = perBatch * batches;
                
                let sub = resolve(ingName.trim(), totalReq, inv);
                // Merge results
                for(let k in sub.needs) needs[k] = (needs[k]||0) + sub.needs[k];
                sub.steps.forEach(s => steps.push(`-- ${s}`));
            });
        }
        return {needs, steps};
    }

    function calculateAll() {
        const item = document.getElementById("calc-item").value;
        const amt = document.getElementById("calc-amount").value;
        if(!item) return;

        const res = resolve(item, amt);
        
        let html = `<h3>Shopping List</h3><ul>`;
        for(let [k,v] of Object.entries(res.needs)) html += `<li>${k}: ${v}</li>`;
        html += `</ul><h3>Steps</h3><div style="font-size:0.9em; opacity:0.8">` + res.steps.map(s=>`<div>${s}</div>`).join("") + "</div>";
        
        document.getElementById("calc-results").innerHTML = html;
    }

    // Initialize
    loadAllCSVs();

</script>
</body>
</html>
