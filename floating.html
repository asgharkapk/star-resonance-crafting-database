<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Recipe Graph Viewer</title>
<style>
  body { margin:0; overflow:hidden; font-family:Arial,sans-serif; background:#eef2f5; }
  #uploadBox { position:absolute; top:10px; left:10px; background:white; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:100; }
  #infoBox { position:absolute; top:10px; right:10px; width:280px; background:white; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); font-size:14px; display:none; z-index:100; }
  #infoBox h3 { margin-top:0; }
  svg text { pointer-events:none; font-size:12px; }
</style>
</head>
<body>

<div id="uploadBox">
  <strong>Upload JSON:</strong><br>
  <input type="file" id="fileInput" accept=".json">
</div>
<div id="infoBox"></div>
<svg id="graph" width="100%" height="100%"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const width = window.innerWidth;
const height = window.innerHeight;

const svg = d3.select("#graph")
  .attr("width", width)
  .attr("height", height);

const svgGroup = svg.append("g"); // for zooming

// Zooming
svg.call(d3.zoom().on("zoom", (event) => {
  svgGroup.attr("transform", event.transform);
}));

const infoBox = document.getElementById("infoBox");

document.getElementById("fileInput").addEventListener("change", handleFile);

function handleFile() {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      buildGraph(data);
    } catch(err) {
      alert("Invalid JSON format");
      console.error(err);
    }
  };
  reader.readAsText(file);
}

function buildGraph(data) {
  const items = data.items;
  let nodes = [];
  let links = [];

  // Add item nodes
  Object.keys(items).forEach(name => nodes.push({id:name, type:"item"}));

  // Add FARM node if any item has farm source
  if(Object.values(items).some(i => i.sources?.some(s => s.type==="farm"))) {
    nodes.push({id:"FARM", type:"farm"});
  }

  // Add shop nodes
  const shopSet = new Set();
  Object.values(items).forEach(i => i.sources?.forEach(s => {
    if(s.type==="shop") shopSet.add(s.shop);
  }));
  shopSet.forEach(shop => nodes.push({id:"SHOP: "+shop, type:"shop", currency:data.shops?.[shop]?.currency || "Unknown"}));

  // Deduplicate nodes
  nodes = Array.from(new Map(nodes.map(n=>[n.id,n])).values());

  // Build links
  Object.keys(items).forEach(name => {
    const entry = items[name];
    entry.sources?.forEach(src => {
      if(src.type==="farm") links.push({source:"FARM", target:name, label:"farm"});
      if(src.type==="craft") src.from.forEach(f => links.push({source:f, target:name, label:"craft"}));
      if(src.type==="shop") links.push({source:"SHOP: "+src.shop, target:name, label:src.currency+" "+src.price});
    });
  });

  // Clear previous graph
  svgGroup.selectAll("*").remove();

  // Force simulation
  const sim = d3.forceSimulation(nodes)
    .force("link", d3.forceLink(links).id(d => d.id).distance(150))
    .force("charge", d3.forceManyBody().strength(-350))
    .force("center", d3.forceCenter(width/2, height/2))
    .force("collide", d3.forceCollide(40));

  // Draw links
  const link = svgGroup.append("g")
    .attr("stroke","#999")
    .selectAll("line")
    .data(links)
    .enter()
    .append("line")
    .attr("stroke-width", 1.5);

  // Draw nodes
  const node = svgGroup.append("g")
    .selectAll("g")
    .data(nodes)
    .enter()
    .append("g")
    .call(d3.drag()
      .on("start",(event,d)=>{if(!event.active) sim.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y;})
      .on("drag",(event,d)=>{d.fx=event.x; d.fy=event.y;})
      .on("end",(event,d)=>{if(!event.active) sim.alphaTarget(0); d.fx=null; d.fy=null;}));

  node.append("circle")
    .attr("r", 18)
    .attr("fill", d => d.type==="item"?"#79a7ff":d.type==="shop"?"#ffb347":"#8BC34A")
    .attr("stroke","#333")
    .attr("stroke-width",1.5);

  node.append("text")
    .attr("text-anchor","middle")
    .attr("y",4)
    .text(d=>d.id);

  node.on("click", (event, n)=> showInfo(n, items));

  sim.on("tick", () => {
    link
      .attr("x1",d=>d.source.x)
      .attr("y1",d=>d.source.y)
      .attr("x2",d=>d.target.x)
      .attr("y2",d=>d.target.y);
    node.attr("transform", d=>`translate(${d.x},${d.y})`);
  });
}

function showInfo(node, items) {
  if(node.type!=="item"){ infoBox.style.display="none"; return; }
  const entry = items[node.id];
  let html = `<h3>${node.id}</h3><strong>Sources:</strong><br>`;
  entry.sources?.forEach(src => {
    if(src.type==="farm") html += "• Farmable<br>";
    if(src.type==="craft") html += `• Craft from ${src.from.join(", ")} (Cost: ${src.currency} ${src.price})<br>`;
    if(src.type==="shop") html += `• Buy at ${src.shop} — ${src.price} ${src.currency}<br>`;
  });
  html += "<br><strong>Used In:</strong><br>";
  entry.used_in?.forEach(u => html += `• ${u}<br>`);
  infoBox.innerHTML = html;
  infoBox.style.left = `${node.x + 20}px`;
  infoBox.style.top = `${node.y + 20}px`;
  infoBox.style.display = "block";
}
</script>

</body>
</html>
