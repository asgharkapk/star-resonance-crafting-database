<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Star Resonance Crafting Guide</title>

<style>
/* ======== Global Layout ======== */
:root {
  --bg-dark: #0a0c16;
  --bg-panel: rgba(255, 255, 255, 0.06);
  --accent: #00c8ff;
  --accent-glow: 0 0 12px rgba(0,200,255,0.6);
  --text-light: #f0f3ff;
  --text-dim: #8ba0b5;
  --radius: 14px;
  --transition: 0.3s ease;
}

body {
  margin: 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  background: radial-gradient(circle at top, #111428, #05060e);
  color: var(--text-light);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ======== Header ======== */
header {
  background: rgba(10,14,30,0.6);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  text-align: center;
  padding: 2rem 1rem;
  box-shadow: 0 2px 20px rgba(0,0,0,0.4);
}
header h1 {
  margin: 0;
  font-size: 2.2rem;
  color: var(--accent);
  letter-spacing: 2px;
  text-transform: uppercase;
  text-shadow: var(--accent-glow);
}

/* ======== Navigation ======== */
nav {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 1.2rem;
  padding: 0.8rem 0;
  background: rgba(255,255,255,0.05);
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
nav a {
  color: var(--text-dim);
  text-decoration: none;
  font-weight: 500;
  position: relative;
  transition: var(--transition);
}
nav a::after {
  content: "";
  position: absolute;
  bottom: -4px;
  left: 0;
  width: 0%;
  height: 2px;
  background: var(--accent);
  transition: var(--transition);
}
nav a:hover {
  color: var(--accent);
}
nav a:hover::after {
  width: 100%;
}

/* ======== Main ======== */
main {
  flex: 1;
  max-width: 1100px;
  margin: 2rem auto;
  padding: 0 1rem 4rem;
}
section {
  background: var(--bg-panel);
  border-radius: var(--radius);
  margin-bottom: 2rem;
  padding: 1.5rem 2rem;
  box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
  backdrop-filter: blur(6px);
  transition: var(--transition);
}
section:hover {
  box-shadow: inset 0 0 30px rgba(0,200,255,0.1);
}
h2 {
  border-left: 4px solid var(--accent);
  padding-left: 10px;
  color: var(--accent);
  margin-top: 0;
  text-transform: capitalize;
}

/* ======== Tables ======== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 0.95rem;
}
th, td {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
th {
  background: rgba(255,255,255,0.08);
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1px;
}
tr:nth-child(even) {
  background: rgba(255,255,255,0.03);
}

/* ======== Links and Highlights ======== */
.item-link {
  color: var(--accent);
  cursor: pointer;
  text-decoration: underline;
  transition: var(--transition);
}
.item-link:hover {
  color: #fff;
  text-shadow: var(--accent-glow);
}
.highlight {
  color: var(--accent);
  font-weight: bold;
}

/* ======== Modal ======== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(5, 8, 20, 0.8);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}
.modal.hidden { display: none; }

.modal-content {
  background: linear-gradient(135deg, rgba(15,18,35,0.95), rgba(8,10,25,0.95));
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius);
  padding: 2rem;
  max-width: 600px;
  width: 90%;
  color: var(--text-light);
  box-shadow: 0 0 20px rgba(0,200,255,0.25);
  animation: popIn 0.3s ease;
}
@keyframes popIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
#modal-close {
  float: right;
  font-size: 1.8rem;
  cursor: pointer;
  color: var(--accent);
  transition: var(--transition);
}
#modal-close:hover { color: #fff; text-shadow: var(--accent-glow); }

/* ======== Footer ======== */
footer {
  text-align: center;
  padding: 1.5rem;
  color: var(--text-dim);
  border-top: 1px solid rgba(255,255,255,0.1);
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(6px);
  font-size: 0.9rem;
}
footer a {
  color: var(--accent);
  text-decoration: none;
}
footer a:hover { text-decoration: underline; }
</style>
</head>

<body>
<header>
  <h1>Star Resonance Crafting Guide</h1>
</header>

<nav>
  <a href="#overview">Overview</a>
  <a href="#materials">Materials</a>
  <a href="#recipes">Recipes</a>
  <a href="#cost">Cost Efficiency</a>
</nav>

<main>
  <section id="overview">
    <h2>Overview</h2>
    <p>Welcome to the <span class="highlight">Star Resonance Crafting Guide</span> ‚Äî your futuristic terminal for discovering crafting materials, artisanry recipes, and cost optimization paths.</p>
  </section>

  <section id="csv-output">
    <!-- Dynamic CSV content will appear here -->
  </section>
</main>

<!-- ===== Modal ===== -->
<div id="item-modal" class="modal hidden">
  <div class="modal-content">
    <span id="modal-close">&times;</span>
    <h2 id="modal-title"></h2>
    <div id="modal-details"></div>
  </div>
</div>

<!-- ===========================
   üî• CRAFTING CALCULATOR 
   =========================== -->
<section id="calculator">
  <h2>Crafting Calculator</h2>

  <!-- Target Item Table -->
  <table id="calc-target-table">
    <thead>
      <tr>
        <th>Target Item</th>
        <th>Amount Needed</th>
        <th>Amount Owned</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><select id="calc-item"></select></td>
        <td><input type="number" class="calc-amount" min="1" value="1"></td>
        <td><input type="number" class="calc-have" min="0" value="0"></td>
      </tr>
    </tbody>
  </table>

  <!-- User Currencies -->
  <table id="calc-currency-table">
    <thead>
      <tr><th>Currency</th><th>Amount Owned</th></tr>
    </thead>
    <tbody>
      <tr><td>F</td><td><input type="number" class="calc-currency" value="0"></td></tr>
      <tr><td>H</td><td><input type="number" class="calc-currency" value="0"></td></tr>
      <tr><td>L</td><td><input type="number" class="calc-currency" value="0"></td></tr>
    </tbody>
  </table>

  <!-- User Recipes Table -->
  <h3>User Recipes</h3>
  <table id="user-recipes">
    <thead>
      <tr>
        <th>Action</th><th>Cin</th><th>From</th><th>Cout</th><th>To</th><th>Cost</th><th>Remove</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="add-user-recipe">Add Recipe Row</button>

  <!-- Results Table -->
  <h3>Required Materials & Costs</h3>
  <div id="calc-results"></div>

  <!-- Full Recipe Paths -->
  <h3>Full Crafting Paths</h3>
  <div id="calc-recipe-paths"></div>

  <!-- Debug / Errors -->
  <div id="calc-debug" style="color:red; margin-top:10px;"></div>
</section>
<!-- ===========================
   üî• CRAFTING CALCULATOR 
   =========================== -->

<footer>
  <p>¬© 2025 Star Resonance Fan Project ‚Äî Built by the community. Visit <a href="https://asgharkapk.github.io/star-resonance-crafting-database/">project page</a>.</p>
</footer>

<!-- ===== JavaScript (logic unchanged) ===== -->
<script>
async function loadCSV(path){
  const res = await fetch(path);
  const text = await res.text();
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",").map(h=>h.trim());
  return lines.slice(1).map(line=>{
      const values = [];
      let current="", inQuotes=false;
      for(let c of line){
          if(c==='"') inQuotes=!inQuotes;
          else if(c===','&&!inQuotes){values.push(current.trim());current="";}
          else current+=c;
      }
      values.push(current.trim());
      const row={};
      const seen={};
      headers.forEach((h,i)=>{
          let key=h;
          if(seen[h]) key=`${h}_${++seen[h]}`;
          else seen[h]=1;
          row[key]=values[i]||"";
      });
      return row;
  });
}

function makeClickableCell(text){
  return `<span class="item-link" data-item="${text}">${text}</span>`;
}

function createTableSection(filename, headers, rows){
  const container=document.getElementById("csv-output");
  const section=document.createElement("section");
  const title=filename.replace(".csv","").replace(/_/g," ");
  section.innerHTML=`<h2>${title}</h2><table>
  <thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead>
  <tbody>${rows.map(r=>`<tr>${headers.map(h=>{
      const val=r[h]||"";
      if(h.toLowerCase().includes("item")||h.toLowerCase().includes("to")||h.toLowerCase().includes("from")){
          return `<td>${makeClickableCell(val)}</td>`;
      }
      return `<td>${val}</td>`;
  }).join("")}</tr>`).join("")}</tbody></table>`;
  container.appendChild(section);
}

let allData={};
async function loadAllCSVs(){
  const DATA_DIR="./data";
  try{
      const resp=await fetch(`${DATA_DIR}/index.json`);
      if(!resp.ok) throw new Error("index.json not found");
      const {files}=await resp.json();
      for(const file of files){
          const rows=await loadCSV(`${DATA_DIR}/${file}`);
          if(rows.length>0){
              createTableSection(file,Object.keys(rows[0]),rows);
              allData[file.replace(/\.[^/.]+$/,"").toLowerCase()]=rows;
          }
      }
  }catch(e){
      document.getElementById("csv-output").innerHTML=`<p style="color:red;">‚ö†Ô∏è Error loading CSVs: ${e.message}</p>`;
  }
}
loadAllCSVs();

document.addEventListener("click",async e=>{
  if(!e.target.classList.contains("item-link")) return;
  const item=e.target.dataset.item.toLowerCase();
  const modal=document.getElementById("item-modal");
  const title=document.getElementById("modal-title");
  const details=document.getElementById("modal-details");
  title.textContent=e.target.dataset.item;
  details.innerHTML="<p>Loading details...</p>";
  modal.classList.remove("hidden");

  let sources=[],usedIn=[],shopData=[];
  Object.values(allData).forEach(rows=>{
      rows.forEach(r=>{
          const action=r.action||r.category||"‚Äî";
          const from=r.from||"";
          const to=r.to||"";
          const cost=r.cost||r.cost_F||r.cost_L||r.cost_H||"N/A";
          const cin=r.cin||"";
          const cout=r.cout||"";
          if(to.toLowerCase()===item) sources.push({action,from,to,cost,cin,cout});
          if(from.toLowerCase().includes(item)) usedIn.push({action,from,to,cost,cin,cout});
          if(r.item && r.item.toLowerCase()===item) shopData.push(r);
      });
  });

  let html="";
  if(sources.length) html+=`<h3>üî® Comes From:</h3><ul>`+
      sources.map(s=>`<li>${s.action}: ${s.cin||""}${s.from} ‚Üí ${s.cout||""}${s.to} (${s.cost})</li>`).join("")+
      "</ul>";
  if(usedIn.length) html+=`<h3>üß© Used In:</h3><ul>`+
      usedIn.map(u=>`<li>${u.action}: ${u.cin||""}${u.from} ‚Üí ${u.cout||""}${u.to} (${u.cost})</li>`).join("")+
      "</ul>";
  if(shopData.length) html+=`<h3>üè™ Shop Prices:</h3><ul>`+
      shopData.map(s=>`<li>${s.source}: ${s.cost}${s.currency||""}</li>`).join("")+
      "</ul>";
  if(!html) html="<p>No details found.</p>";
  const cheapest=shopData.filter(s=>s.cost).sort((a,b)=>parseFloat(a.cost)-parseFloat(b.cost))[0];
  if(cheapest) html+=`<h3>üí° Best Option:</h3><p>Buy from <strong>${cheapest.source}</strong> for ${cheapest.cost}${cheapest.currency||""}</p>`;
  details.innerHTML=html;
});

document.getElementById("modal-close").addEventListener("click",()=>{
  document.getElementById("item-modal").classList.add("hidden");
});

/* ===========================
   üî• CRAFTING CALCULATOR CORE
   =========================== */
/* ===== Redesigned Option B Calculator ===== */

let customRecipes = [];

/* ===== Utility Functions ===== */
function updateItemDropdown(){
  const select = document.getElementById("calc-item");
  select.innerHTML = "";
  const itemsSet = new Set();

  Object.values(allData).forEach(rows=>{
    rows.forEach(r=>{
      if(r.to) itemsSet.add(r.to);
      if(r.from) r.from.split("+").forEach(f=>itemsSet.add(f.trim()));
    });
  });
  customRecipes.forEach(r=>{
    if(r.to) itemsSet.add(r.to);
    if(r.from) r.from.split("+").forEach(f=>itemsSet.add(f.trim()));
  });

  [...itemsSet].sort().forEach(i=>{
    const opt = document.createElement("option");
    opt.value=i; opt.textContent=i;
    select.appendChild(opt);
  });
}

/* ===== User Recipes Table ===== */
function renderUserRecipes(){
  const tbody = document.querySelector("#user-recipes tbody");
  tbody.innerHTML = "";
  customRecipes.forEach((r,idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td><input value="${r.action||'CRAFTING'}"></td>
                    <td><input value="${r.cin||''}"></td>
                    <td><input value="${r.from||''}"></td>
                    <td><input value="${r.cout||''}"></td>
                    <td><input value="${r.to||''}"></td>
                    <td><input value="${r.cost||''}"></td>
                    <td><button class="remove-recipe">√ó</button></td>`;
    tbody.appendChild(tr);

    tr.querySelector(".remove-recipe").onclick = ()=>{
      customRecipes.splice(idx,1);
      renderUserRecipes();
      calculateAll();
    };

    tr.querySelectorAll("input").forEach(input=>{
      input.oninput = ()=>{
        r.action = tr.children[0].querySelector("input").value;
        r.cin = tr.children[1].querySelector("input").value;
        r.from = tr.children[2].querySelector("input").value;
        r.cout = tr.children[3].querySelector("input").value;
        r.to = tr.children[4].querySelector("input").value;
        r.cost = tr.children[5].querySelector("input").value;
        calculateAll();
      };
    });
  });
}

document.getElementById("add-user-recipe").onclick = ()=>{
  customRecipes.push({action:"CRAFTING",cin:"1x",from:"",cout:"1x",to:"",cost:""});
  renderUserRecipes();
  updateItemDropdown();
};

/* ===== Parse Inputs ===== */
function getTargetItem(){ return document.querySelector("#calc-target-table select").value; }
function getTargetAmount(){ return parseInt(document.querySelector("#calc-target-table .calc-amount").value); }
function getTargetHave(){ return parseInt(document.querySelector("#calc-target-table .calc-have").value)||0; }
function getCurrencies(){
  const out={};
  document.querySelectorAll(".calc-currency").forEach((input,i)=>{
    const curr = input.parentElement.previousElementSibling.textContent;
    out[curr] = parseFloat(input.value)||0;
  });
  return out;
}

/* ===== Gather Recipes ===== */
function gatherAllRecipes(){
  const recipes=[];
  Object.values(allData).forEach(rows=>{
    rows.forEach(r=>{
      if(r.action?.toUpperCase()==="CRAFTING" && r.from && r.to) recipes.push({...r});
      if(r.action?.toUpperCase()==="STORE" && r.item) recipes.push({...r});
    });
  });
  return recipes.concat(customRecipes);
}

/* ===== Parse Quantity ===== */
function parseQty(txt){
  if(!txt) return 1;
  const m=txt.match(/(\d+)\s*x/i);
  return m ? parseInt(m[1]) : 1;
}

/* ===== Multi-path Resolver with Paths ===== */
function resolveItemFull(item, amount, recipes, inv, path=[], seen=new Set()){
  const name=item.toLowerCase();
  if(seen.has(name+amount)) return {needs:{}, paths:[]}; // prevent cycles
  seen.add(name+amount);

  const result = {needs:{}, paths:[]};
  try{
    // Deduct inventory
    const owned = inv[name]||0;
    if(owned>=amount){ inv[name]-=amount; return result; }
    amount -= owned; inv[name]=0;

    // Find all recipes producing this item
    const prod = recipes.filter(r=>r.to?.toLowerCase()===name);
    if(prod.length===0){ 
      result.needs[item]=amount;
      result.paths.push(path.concat(`${amount}x ${item}`));
      return result;
    }

    // For multi-path, iterate all recipes
    prod.forEach(r=>{
      const perOut = parseQty(r.cout);
      const batches = Math.ceil(amount/perOut);
      let newPath = path.slice();
      let fromStr = r.from || '';
      if(fromStr) newPath.push(`${r.action||'CRAFTING'}: ${r.cin||''}${r.from} -> ${r.cout||''}${r.to} (${r.cost||''})`);
      let subNeeds = {};
      let subPaths = [];
      if(r.from){
        r.from.split("+").forEach(f=>{
          const qty = parseQty(r.cin) * batches;
          const sub = resolveItemFull(f.trim(), qty, recipes, inv, newPath, seen);
          Object.keys(sub.needs).forEach(k=>subNeeds[k]=(subNeeds[k]||0)+sub.needs[k]);
          subPaths = subPaths.concat(sub.paths);
        });
      }
      Object.keys(subNeeds).forEach(k=>result.needs[k]=(result.needs[k]||0)+subNeeds[k]);
      result.paths = result.paths.concat(subPaths.length?subPaths:[newPath]);
    });
  } catch(e){
    document.getElementById("calc-debug").textContent="Calculation error: "+e.message;
    console.error(e);
  }
  return result;
}

/* ===== Render Tables ===== */
function calculateAll(){
  try{
    document.getElementById("calc-debug").textContent="";
    const target=getTargetItem();
    const amount=getTargetAmount();
    const have=getTargetHave();
    const currencies=getCurrencies();
    const inv={}; inv[target.toLowerCase()]=have;
    const recipes=gatherAllRecipes();

    const res = resolveItemFull(target, amount, recipes, inv);

    // Required Materials & Costs Table
    const rows = [];
    Object.keys(res.needs).forEach(k=>{
      const qty=res.needs[k];
      const shops = recipes.filter(r=>r.store && r.to.toLowerCase()===k.toLowerCase());
      let best="N/A";
      if(shops.length){
        const s = shops.sort((a,b)=>parseFloat(a.cost||0)-parseFloat(b.cost||0))[0];
        best = `${qty * parseFloat(s.cost||0)} ${s.currency||''} (${s.store||''})`;
      }
      rows.push({item:k, qty, best});
    });

    document.getElementById("calc-results").innerHTML=`
      <table>
        <thead><tr><th>Item</th><th>Required</th><th>Best Cost</th></tr></thead>
        <tbody>
        ${rows.map(r=>`<tr><td>${r.item}</td><td>${r.qty}</td><td>${r.best}</td></tr>`).join("")}
        </tbody>
      </table>`;

    // Full Recipe Paths
    const pathsDiv = document.getElementById("calc-recipe-paths");
    pathsDiv.innerHTML = "";
    res.paths.forEach(p=>{
      pathsDiv.innerHTML += "<p>"+p.join(" ‚Üí ")+"</p>";
    });

  } catch(e){
    document.getElementById("calc-debug").textContent="Error during calculation: "+e.message;
    console.error(e);
  }
}

/* ===== Auto-update on input change ===== */
document.querySelectorAll("#calc-target-table input, #calc-target-table select, .calc-currency").forEach(inp=>{
  inp.oninput = calculateAll;
});

/* ===== Initialize ===== */
updateItemDropdown();
renderUserRecipes();
calculateAll();
/* ===========================
   üî• CRAFTING CALCULATOR CORE
   =========================== */

</script>
</body>
</html>
